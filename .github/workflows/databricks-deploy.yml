name: CI-CD Databricks Deploy

on:
  push:
    branches: [ "main" ]
    paths:
      - "notebooks/**"
      - ".github/workflows/**"

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional: if your notebooks are .py, we can syntax-check them.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Syntax check (only .py files)
        run: |
          python - << 'PY'
          import pathlib, sys
          files = list(pathlib.Path("notebooks").rglob("*.py"))
          print("PY files found:", len(files))
          for f in files:
              print("Checking:", f)
              compile(f.read_text(encoding="utf-8"), str(f), "exec")
          print("Syntax OK")
          PY

  cd:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Databricks CLI
        run: pip install databricks-cli

      - name: Configure Databricks CLI
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          cat > ~/.databrickscfg << EOF
          [DEFAULT]
          host = ${DATABRICKS_HOST}
          token = ${DATABRICKS_TOKEN}
          EOF

      - name: Deploy notebooks to Databricks Workspace
        run: |
          databricks workspace mkdirs /Shared/ShopSmartAI
          databricks workspace import_dir ./notebooks /Shared/ShopSmartAI --overwrite
          echo "Deployed to /Shared/ShopSmartAI"